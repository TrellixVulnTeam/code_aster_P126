# coding=utf-8

# Copyright (C) 1991 - 2015  EDF R&D                www.code-aster.org
#
# This file is part of Code_Aster.
#
# Code_Aster is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 2 of the License, or
# (at your option) any later version.
#
# Code_Aster is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with Code_Aster.  If not, see <http://www.gnu.org/licenses/>.

import os.path as osp

from waflib import TaskGen, Configure, Logs, Utils, Errors


def options(self):
    self.load('cython')

def configure(self):
    self.load('cython')
    self.check_cython_includes()

def build(self):
    get_srcs = self.path.get_src().ant_glob
    env = self.all_envs[self.variant]

    self(
        features = 'py',
            name = 'code_aster_py',
          source = get_srcs('**/*.py'),
    install_from = '.',
    install_path = osp.join(env.ASTERLIBDIR, 'code_aster'),
    )

    for cymodule in get_srcs('**/*.pyx'):
        path = cymodule.abspath()
        modname = osp.splitext(osp.basename(path))[0]
        dirname = osp.basename(osp.dirname(path))

        self(
            features = 'cxx cxxshlib pyext',
              source = cymodule,
              target = osp.join(dirname, modname),
                 use = 'asterlib',
        install_path = osp.join(env.ASTERLIBDIR, 'code_aster', dirname),
        )


###############################################################################
@Configure.conf
def check_cython_includes(self):
    cypath = osp.join(self.path.get_src().parent.abspath(), 'code_aster')
    self.env.append_unique('INCLUDES', cypath)
